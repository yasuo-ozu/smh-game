#include "smh_common.h"

smh_image image_block1 = {
	16, 16, 1, NULL,
	{0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 
	0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 
	0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 
	0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 
	0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 
	0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 
	0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 
	0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 
	0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 
	0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 
	0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 
	0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 
	0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 
	0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 
	0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 0x77, 0x72, 
	0x77, 0x77, 0x77, 0x72, 0x77, 0x77, 0x77, 0x72}
};

smh_image image_character1 = {
	8, 12, 1, NULL,
	{
		0x00, 0x04, 0x40, 0x00, 
		0x04, 0x44, 0x44, 0x40, 
		0x37, 0x77, 0x77, 0x73, 
		0x34, 0x34, 0x43, 0x43, 
		0x05, 0x24, 0x42, 0x50, 
		0x04, 0x44, 0x44, 0x44, 
		0x07, 0x74, 0x47, 0x77, 
		0x77, 0x44, 0x44, 0x77, 
		0x77, 0x54, 0x45, 0x77, 
		0x77, 0x54, 0x45, 0x77, 
		0x33, 0x55, 0x55, 0x33, 
		0x01, 0x10, 0x01, 0x10
	}
};

smh_image image_greeting2 = {
	48, 6, 1, NULL,
	{
		0x22, 0x22, 0x20, 0x02, 0x22, 0x00, 0x22, 0x00, 0x02, 0x20, 0x22, 0x22, 0x00, 0x22, 0x20, 0x02, 0x00, 0x02, 0x02, 0x22, 0x20, 0x22, 0x22, 0x00,
		0x20, 0x00, 0x00, 0x20, 0x00, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x00, 0x02, 0x00, 0x02, 0x02, 0x00, 0x02, 0x02, 0x00, 0x00, 0x20, 0x00, 0x20,
		0x20, 0x00, 0x00, 0x20, 0x00, 0x20, 0x20, 0x02, 0x00, 0x20, 0x20, 0x00, 0x02, 0x00, 0x02, 0x02, 0x00, 0x02, 0x02, 0x00, 0x00, 0x20, 0x00, 0x20,
		0x20, 0x02, 0x20, 0x22, 0x22, 0x20, 0x20, 0x00, 0x00, 0x20, 0x22, 0x22, 0x02, 0x00, 0x02, 0x02, 0x00, 0x02, 0x02, 0x22, 0x20, 0x22, 0x22, 0x00,
		0x20, 0x00, 0x20, 0x20, 0x00, 0x20, 0x20, 0x00, 0x00, 0x20, 0x20, 0x00, 0x02, 0x00, 0x02, 0x00, 0x20, 0x20, 0x02, 0x00, 0x00, 0x20, 0x02, 0x00,
		0x22, 0x22, 0x20, 0x20, 0x00, 0x20, 0x20, 0x00, 0x00, 0x20, 0x22, 0x22, 0x00, 0x22, 0x20, 0x00, 0x02, 0x00, 0x02, 0x22, 0x20, 0x20, 0x00, 0x20
	}
};

smh_image image_goal = {
	16, 16, 1, NULL,
	{
		0x00, 0x00, 0x00, 0x02, 0x88, 0x88, 0x00, 0x00, 
		0x00, 0x00, 0x00, 0x02, 0x88, 0x88, 0x00, 0x00, 
		0x00, 0x00, 0x00, 0x02, 0x88, 0x88, 0x00, 0x00, 
		0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 
		0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 
		0x00, 0x00, 0x00, 0x09, 0x90, 0x00, 0x00, 0x00, 
		0x00, 0x00, 0x09, 0x99, 0x99, 0x90, 0x00, 0x00, 
		0x00, 0x00, 0x99, 0x99, 0x99, 0x99, 0x00, 0x00, 
		0x00, 0x09, 0x99, 0x99, 0x99, 0x99, 0x90, 0x00, 
		0x00, 0x09, 0x99, 0x66, 0x66, 0x69, 0x90, 0x00, 
		0x00, 0x09, 0x99, 0x69, 0x99, 0x99, 0x90, 0x00, 
		0x00, 0x09, 0x99, 0x69, 0x99, 0x99, 0x90, 0x00, 
		0x00, 0x09, 0x99, 0x69, 0x96, 0x69, 0x90, 0x00, 
		0x00, 0x09, 0x99, 0x69, 0x99, 0x69, 0x90, 0x00, 
		0x00, 0x09, 0x99, 0x66, 0x66, 0x69, 0x90, 0x00, 
		0x00, 0x09, 0x99, 0x99, 0x99, 0x99, 0x90, 0x00
	}
};

smh_object *smh_create_object(smh_game *game, int type) {
	smh_object *obj = malloc(sizeof(smh_object));
	obj->next = NULL;
	obj->type = type;
	obj->x = 0.0; obj->y = 0.0;
	obj->vx = obj->vy = 0.0;
	obj->width = 100; obj->height = 150;
	obj->color = 0xFFFF0000;
	obj->focus = 0;
	obj->collision_mode = 0;
	if (type == 1) {	// block
		obj->width = 32; obj->height = 32;
		obj->image = &image_block1;
		obj->collision_mode = 1;
	} else if (type == 2) {	// schromahher
		obj->width = 8; obj->height = 12;
		obj->image = &image_character1;
		obj->focus = 1;
	} else if (type == 3) {	// game over
		obj->x = 70; obj->y = 42;
		obj->width = 48; obj->height = 6;
		obj->image = &image_greeting2;
	} else if (type == 4) { // goal
		obj->width = obj->height = 16;
		obj->image = &image_goal;
		obj->collision_mode = 2;
	}
	if (obj->image->image == NULL) {
		obj->image->image = smh_create_canvas(game->win, obj->width, obj->height);
		smh_graphic *gc = smh_window_create_graphic(obj->image->image);
		smh_draw_image(obj->image->image, gc, obj->image, 0, 0);
		smh_window_flush(obj->image->image);
		smh_window_dispose_graphic(obj->image->image, gc);
	}
	return obj;
}

void smh_destroy_object(smh_object *obj) {
	free(obj);
}

int smh_update_object(smh_object *obj, smh_game *game, ullong time) {
	UNUSED(obj, time, game);
	// if (obj->focus == 0) return 0;
	// if (game->key & KEY_UP) obj->vy -= 1;
	// if (game->key & KEY_DOWN) obj->vy += 1;
	// if (game->key & KEY_LEFT) obj->vx -= 1;
	// if (game->key & KEY_RIGHT) obj->vx += 1;
	// obj->x += obj->vx;
	// obj->y += obj->vy;
	return 0;
}

void smh_draw_object(smh_object *obj, smh_game *game, smh_graphic *g, double x, double y) {
	UNUSED(g);
	smh_graphic *gc = smh_window_create_graphic(obj->image->image);
	int lx = (int)x, ly = (int)y, rx = 0, ry = 0, w = obj->image->width, h = obj->image->height;
	while (ry < obj->height) {
		rx = 0;
		while (rx < obj->width) {
			smh_draw_canvas(game->win, obj->image->image, gc, lx + rx, ly + ry, MIN(obj->image->width, obj->width - rx), MIN(obj->image->height, obj->height - ry));
			rx += w;
		}
		ry += h;
	}
	smh_window_dispose_graphic(obj->image->image, gc);
}



